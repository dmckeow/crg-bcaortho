nextflow.enable.dsl = 2

profiles {
    apptainer_on {
        apptainer.enabled = true
    }
    conda_on {
        conda.enabled = true
    }
    local {
        process.executor = 'local'
        conda.enabled = true
        conda.useMamba = true
    }
    univ_hpc {
        process.executor = 'slurm'
        conda.enabled = true
        process.resourceLimits = [
            memory: 750.GB,
            cpus: 200,
            time: 30.d
        ]
    }

}

//process {
    // defaults for all processes
  //  cpus = 2
    //memory = 2.GB
    // allocations for a specific process
    //withName: 'GATK_JOINTGENOTYPING' {
    //    cpus = 8
    //}
//}


/*
 * Pipeline parameters
 */

params {
    // Input for all
    outdir              = 'results'

    // BAM INDEX
    sample_sheet        = "data/bam/sample_sheet.csv"
    run_bam_index       = false

    // INITIAL ORTHOLOGY
    fasta_dir           = "/users/asebe/dmckeown/projects/crg-bcaortho/data"
    prior_run           = null
    run_orthofinder     = true

    // SEARCH
    run_search          = true
    search {
        gene_family_info   = "/users/asebe/dmckeown/projects/BCA_phylogeny/data/genefam.tsv"
        gene_family_name   = "Myosin"
        hmm_dir            = "/users/asebe/dmckeown/projects/BCA_phylogeny/data/hmms"
    }

    // CLUSTER_DMND_MCL
    run_cluster_dmnd_mcl        = true
    cluster_dmnd_mcl {
        dmnd_params             = "--max-target-seqs 100 --more-sensitive --quiet"
        mcl_params              = ""
        mcl_inflation           = 1.5
        mcl_fasta_outdir        = "."
    }
}

// Process specific parameters
process {
    withName: 'SAMTOOLS_INDEX' {
        publishDir = [
            path: "${params.outdir}/samtools_index",
            mode: 'symlink',
            saveAs: { filename -> filename.endsWith('.bai') ? filename : null }
        ]
    }

    withName: 'ORTHOFINDER' {
        publishDir = [
            path: { "${params.outdir}"},
            mode: 'symlink',
            saveAs: { filename -> filename }
        ]
    }

    withName: 'SEARCH' {
        publishDir = [
            path: { "${params.outdir}" },
            mode: 'symlink',
            saveAs: { filename ->
                if (filename.endsWith('.domains.fasta') ||
                    filename.endsWith('.domtable')) {
                    return "${filename}"
                } else {
                    return null
                }
            }
        ]
    }

    withName: 'CLUSTER_DMND_MCL' {
        publishDir = [
            path: { "${params.outdir}" },
            mode: 'symlink',
            saveAs: { filename ->
                if (filename.startsWith('clusters/dmnd_mcl/') &&
                    (filename.endsWith('.dmnd.csv') ||
                    filename.endsWith('.dmnd.csv.abc') ||
                    filename.endsWith('.mcl.fa'))) {
                    return filename
                } else {
                    return null
                }
            }
        ]
    }
}

// Module management
manifest {
    name = 'crg-bcaortho'
    description = 'pipeline'
    author = 'Dean Mckeown'
    version = '1.0.0'
    nextflowVersion = '24.10.0'
    homePage = 'https://github.com/dmckeow/crg-bcaortho'
}